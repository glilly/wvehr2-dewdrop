SPNRPCW ;SD/WDE - Returns INFLUENZA Lab test results;JUL 28, 2008
        ;;3.0;Spinal Cord Dysfunction;;OCT 01, 2006;Build 39
        ;
        ;
        ;   INTEGRATION REFERENCE INQUIRY #4245
        ;   INTEGRATION REFERENCE INQUIRY #4246
        ;   
        ;   
        ;     dfn is ien of the pt
        ;     root is the sorted data in latest date of test first
        ;
COL(ROOT,ICN,SDATE,EDATE)       ;
        K TESTS
        K ^TMP($J)
        K ^TMP($J,"UTIL")
        ;JAS 07/28/08 Replaced all references to ^TMP("RESULTS",$J) to ^TMP("SPN",$J)
        ;             due to ^TMP structure violation found during SQA checklist.
        ;K ^TMP("RESULTS",$J)
        K ^TMP("SPN",$J)
        S ROOT=$NA(^TMP($J))
        S X=SDATE S %DT="T" D ^%DT S SDATE=Y
        S X1=SDATE,X2=-1 D C^%DTC S SDATE=X
        S X=EDATE S %DT="T" D ^%DT S EDATE=Y
        S SPNCNT=0
        S DFN=$$FLIP^SPNRPCIC(ICN)
        S LRDFN=$$LRDFN^LRPXAPIU(DFN) Q:LRDFN'>0
        D RESULTS^LRPXAPI(.ZZ,DFN,"M")
        F  D  Q:'MORE
         . D RESULTS^LRPXAPI(.ITEMS,DFN,"M",100,.MORE,,SDATE,EDATE)
         . ;M ^TMP("RESULTS",$J)=ITEMS
         . M ^TMP("SPN",$J)=ITEMS
        K ITEMS
        S ^TMP($J,"UTILA")="Beginning of MICRO"_U_"EOL999"
        ;S SPNTEST="" F  S SPNTEST=$O(^TMP("RESULTS",$J,SPNTEST)) Q:SPNTEST=""  D
        S SPNTEST="" F  S SPNTEST=$O(^TMP("SPN",$J,SPNTEST)) Q:SPNTEST=""  D
        .;S TSTDATA=$G(^TMP("RESULTS",$J,SPNTEST)) Q:TSTDATA=""
        .S TSTDATA=$G(^TMP("SPN",$J,SPNTEST)) Q:TSTDATA=""
        .S RDATE=$P(SPNTEST,";",3)
        .S SPUTSCEN=$P($$REFVAL^LRPXAPI("LRDFN;MI;RDATE;1"),U,5)
        .;Q:SPUTSCEN=""
        .K SITPC
        .S SITPC=$P($$REFVAL^LRPXAPI("LRDFN;MI;RDATE;0"),U,5)
        .S SITESPEC=$$SPECNM^LRPXAPIU(SITPC)
        .S ACCES=$P($G(TSTDATA),U,11)
        .S DATTAKE=$P(TSTDATA,U,1) S FMDATE=DATTAKE S Y=DATTAKE D DD^%DT S DATTAKE=Y
        .S ^TMP($J,"UTILA",RDATE,"A",0)="BOR999"_U_DATTAKE_U_ACCES_U_SITESPEC_U_SPUTSCEN_U_"EOL999"
        .;
        .;
        .;set up the virology rpt remarks
        .S ^TMP($J,"UTILA",RDATE,"B","VIROLOGY REMARKS",0)="BOS_VIROLOGY_RPT_RMKS"_U_"EOL999"
        .S ^TMP($J,"UTILA",RDATE,"B","VIROLOGY REMARKS",9999999)="EOS_VIROLOGY_RPT_RMKS"_U_"EOL999"
        .S (VIRLINE,LINE,DATA)=""
        .S VIRLINE=$P($$REFVAL^LRPXAPI("LRDFN;MI;RDATE;18,0"),U,4)
        .S LINE=0 F LINE=1:1:VIRLINE S DATA=$$REFVAL^LRPXAPI("LRDFN;MI;RDATE;18,LINE,0") D
        ..S ^TMP($J,"UTILA",RDATE,"B","VIROLOGY REMARKS",LINE)=DATA_U_"EOL999"
        .;
        .;now get the virus information
        .;
        .S (VIRLINE,LINE,DATA)=""
        .S ^TMP($J,"UTILA",RDATE,"C","VIRUS",0)="BOS_VIRUS"_U_"EOL999"
        .S ^TMP($J,"UTILA",RDATE,"C","VIRUS",999999)="EOS_VIRUS"_U_"EOL999"
        .S VIRLINE=$P($$REFVAL^LRPXAPI("LRDFN;MI;RDATE;17,0"),U,4)
        .S LINE=0 F LINE=1:1:VIRLINE S DATA=$$REFVAL^LRPXAPI("LRDFN;MI;RDATE;17,LINE,0") D
        ..S VIRX=$$BUGNM^LRPXAPIU(DATA)
        ..S ^TMP($J,"UTILA",RDATE,"C","VIRUS",LINE)=VIRX_U_"EOL999"
        .S ^TMP($J,"UTILA",RDATE,"D","ZZZZZZZZZZZ",99999999999)="EOR999"_U_"EOL999"
        ;K ^TMP("RESULTS",$J) K ITEMS
        K ^TMP("SPN",$J) K ITEMS
        D COL^SPNRPCW2(ICN,SDATE,EDATE)
ZAP     ;
        K SDATE,EDATE,SUC,CNT,RDATE,LRDFN,SPUTSCEN,ASSES,COLSAMP,REVDT,DATREC
        K REPORDT,REPOTYP,SITESPEC,SPUTSCEN,VIROLSTA,PROVIDER,VIRUS,VIRUSNA
        K VIROIEN,VIROTST,VIRRPIEN,VIRORPT,DATA,SUBCNT,DFN
        K ASSES,CNT,CNT2,COL,COM,COMMET,DATA
        K DATA2,DFN,DTREPTAK,DTSPETAK,EDATE
        K FIELD,FIELD2,FIELDNA,LRDFN,RDATE
        K SPECTYP,SUB,SUBCNT,TST,Y
        K X,VIRUSIEN,VIROLDT,LASTCNT,DATTAKE,%DT,ACCES,FMDATE,LINE,MORE
        K SPNCNT,SPNTEST,TSTDATA,VIRLINE,VIRX,X1,X2,ZZ,A,COLTIME
        K REPDATE,SHOWDT,SITSPEC,SPNTEST,T,TSTNAM,TSTNUM,VALUE,WHATEST
        Q
